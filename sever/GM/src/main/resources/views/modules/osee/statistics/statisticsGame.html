<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>比赛统计</title>

    <!-- 引入 layui.css -->
    <link rel="stylesheet" href="https://unpkg.com/layui@2.6.8/dist/css/layui.css">

    <!-- 引入 layui.js -->
    <script src="//unpkg.com/layui@2.6.8/dist/layui.js" />

    <style>
        .add {
            color: red;
        }
        .minus {
            color: green;
        }

        #container {
            padding-top: 1rem;
        }
    </style>

    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="detail" data-i18n="竞技模式.查看">查看</a>
    </script>

</head>
<body>
<div id="container">
    <div class="search-container">
        <form class="layui-form" lay-filter="searchForm">

            <div class="layui-inline">
                <label class="layui-form-label" data-i18n="竞技模式.时间">时间</label>
                <div class="layui-input-inline">
                    <input type="text" name="date" id="date" placeholder="请选择时间" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" data-i18n="竞技模式.比赛模式">比赛模式</label>
                <div class="layui-input-block">
                    <select name="mode" lay-verify="required" class="LayUiSelectClass">
                        <option value=""></option>
                        <option value="1" >大奖赛</option>
<!--                        <option value="2">全民赛</option>-->
<!--                        <option value="3">满人赛</option>-->
<!--                        <option value="4">道具赛</option>-->
                        <option value="5" >击杀榜</option>
<!--                        <option value="6">连击榜</option>-->
                        <option value="7" >积分榜</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label" data-i18n="竞技模式.类型">类型</label>
                <div class="layui-input-block">
                    <select name="type" lay-verify="required" class="LayUiSelectClass">
                        <option value=""></option>
                        <option value="1" >日赛</option>
                        <option value="2" >周赛</option>
                        <option value="3" >月赛</option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <div class="layui-input-block">
                    <a href="javascript:search();" class="layui-btn layui-btn-normal layui-btn-sm" data-i18n="查询">查询</a>
                    <button type="reset" class="layui-btn layui-btn-primary layui-btn-sm" data-i18n="重置">重置</button>
                </div>
            </div>
        </form>

    </div>


            <table lay-filter="table" id="demo" >
            </table>
</div>

<script src="${ctxStatic}/jquery/jquery-1.12.4.min.js" type="text/javascript"></script>

<script>

if (window.parent.window.$.InitI18next) {
    window.parent.window.$.InitI18next(window.$)
    window.$.InitI18next = window.parent.window.$.InitI18next
}

    let form;
    let tbl;

    layui.use('laydate', function(){
        const laydate = layui.laydate;

        //执行一个laydate实例
        laydate.render({
            elem: '#date' //指定元素
            , range: true
        });
    });

    layui.use('form', function(){
        form = layui.form;
       // form.render();
        //监听提交
        form.on('submit(formDemo)', function(data){
            layer.msg(JSON.stringify(data.field));
            return false;
        });
    });

    layui.use('table', function () {
        let table = layui.table;
        tbl = table.render({
            elem: '#demo' //指定原始表格元素选择器（推荐id选择器）
            ,url: '/ttmy_admin/a/osee/statistics/statistic/games'
            ,page: true
            ,limit: 20
            ,cols: [[ //表头
                {field: '', title: '', width:40, fixed: 'left', type: 'numbers'}
                ,{field: 'createTime', title: `${jsValue('$.i18n.t("竞技模式.日期")')}`, width: 120, sort: true, templet: function (d) {
                        return new Date(d.createTime).format("yyyy-MM-dd");
                    }}
                ,{field: 'number', title: `${jsValue('$.i18n.t("竞技模式.参赛人数")')}`, width:120}
                ,{field: 'income', title: `${jsValue('$.i18n.t("竞技模式.报名收入")')}`, width:140}
                ,{field: 'stock', title: `${jsValue('$.i18n.t("竞技模式.库存")')}`, width: 120}

                ,{field: 'reward', title: `${jsValue('$.i18n.t("竞技模式.奖励支出")')}`, templet: function (d) {
                        return change("金币", d.reward.gold) + change('钻石', d.reward.diamond) + change('低阶鱼雷', d.reward.lowerBall)
                            + change('中阶鱼雷', d.reward.middleBall) + change('高阶鱼雷', d.reward.highBall) + change('锁定技能', d.reward.skillLock)
                            + change('极速技能', d.reward.skillFast) + change('暴击技能', d.reward.skillCrit) + change('冰冻技能', d.reward.skillFrozen)
                            + change('BOSS号角', d.reward.bossBugle);
                    }}

                ,{field: 'receivedReward', title: `${jsValue('$.i18n.t("竞技模式.已领取奖励")')}`, templet: function (d) {
                        return change("金币", d.receivedReward.gold) + change('钻石', d.receivedReward.diamond) + change('低阶鱼雷', d.receivedReward.lowerBall)
                            + change('中阶鱼雷', d.receivedReward.middleBall) + change('高阶鱼雷', d.receivedReward.highBall) + change('锁定技能', d.receivedReward.skillLock)
                            + change('极速技能', d.receivedReward.skillFast) + change('暴击技能', d.receivedReward.skillCrit) + change('冰冻技能', d.receivedReward.skillFrozen)
                            + change('BOSS号角', d.receivedReward.bossBugle);
                    }}

                ,{field: 'type', title: `${jsValue('$.i18n.t("竞技模式.类型")')}`, width: 120, templet: function (d) {
                        return d.type === 1 ? `${jsValue('$.i18n.t("竞技模式.日赛")')}` : ( d.type === 2 ? `${jsValue('$.i18n.t("竞技模式.周赛")')}` : `${jsValue('$.i18n.t("竞技模式.月赛")')}`);
                    }}
                ,{field: 'mode', title: `${jsValue('$.i18n.t("竞技模式.竞技模式")')}`, width: 120, templet: function (d) {
                        return type(d.mode);
                    }}
                ,{field: 'infom', title: `${jsValue('$.i18n.t("竞技模式.比赛详情")')}`, width: 220, align:'center', toolbar: '#barDemo'}
            ]]
            ,parseData: function (res) {
                return {
                    "code": res.result ? 0 : 1,
                    "msg": res.message,
                    "data": res.data,
                    "count": res.count
                }
            }
        });

        table.on('tool(table)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var tr = obj.tr; //获得当前行 tr 的 DOM 对象（如果有的话）

            if(layEvent === 'detail'){ //查看
               sessionStorage.setItem("mode", obj.data.mode);
               sessionStorage.setItem("type", obj.data.type);
               sessionStorage.setItem("date", new Date(obj.data.createTime).toLocaleDateString());
               window.location = "/ttmy_admin/a/osee/statistics/rank";
            }
        });
    });

    let search = function() {
        let data = form.val("searchForm");
        let params = {};
        console.log(data);
        if (date.value !== "") {
            params.startDate = date.value.split(" - ")[0];
            params.endDate = date.value.split(" - ")[1];
        } else {
            params.startDate = null;
            params.endDate = null;
        }
        if (data.mode !== "") {
            params.mode = data.mode;
        } else {
            params.mode = null;
        }

        if (data.type !== "") {
            params.type = data.type;
        } else {
            params.type = null;
        }

        console.log(params);
        tbl.reload({
            where: params
        })
    };

    Date.prototype.format = function(fmt) {
        let obj = {
            '(y+)': this.getFullYear(),
            '(M+)': this.getMonth() + 1,
            '(d+)': this.getDate(),
            '(h+)': this.getHours(),
            '(m+)': this.getMinutes(),
            '(s+)': this.getSeconds()
        };

        for (let reg in obj) {
            if(new RegExp(reg).test(fmt)) {
                fmt = fmt.replace(RegExp.$1, ("" + obj[reg]).length === 1 ? "0" + obj[reg] : obj[reg]);
            }
        }
        return fmt;
    };

    let change = function(name, num) {

        let t = $.i18n.t("竞技模式." + name);

        return num ? t + "*" + num + " " : ""

    };

    let type = function (n) {
        switch (n) {
            case 1: return `${jsValue('$.i18n.t("竞技模式.大奖赛")')}`;
            // case 2: return "全民赛";
            // case 3: return "满人赛";
            // case 4: return "道具赛";
            case 5: return `${jsValue('$.i18n.t("竞技模式.击杀榜")')}`;
            case 7: return `${jsValue('$.i18n.t("竞技模式.积分榜")')}`;
        }
    }

</script>

<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="detail" data-i18n="竞技模式.查看">查看</a>
</script>

<script>

$(() => {

    let a = $('.layui-form-select > dl > dd')

    for (let i = 0; i < a.length; i++) {

        let innerHTML = a[i].innerHTML;

        if (String(innerHTML) !== '') {

            a[i].innerHTML = $.i18n.t("竞技模式." + innerHTML)

        }

    }

    if ($('[data-i18n]').localize) {
        $('[data-i18n]').localize();
    }

    setTimeout(()=>{
        if ($('[data-i18n]').localize) {
            $('[data-i18n]').localize();
        }
    },1000)

})

</script>

</body>
</html>
